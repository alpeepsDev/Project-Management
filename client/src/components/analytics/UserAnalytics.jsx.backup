import React from "react";
import { Card } from "../ui";
import { useTheme } from "../../context";

const UserAnalytics = ({ tasks = [], user }) => {
  const { isDark } = useTheme();

  // Calculate user-specific metrics
  const myTasks = tasks.filter((task) => task.assigneeId === user?.id) || [];
  const completedTasks = myTasks.filter((task) => task.status === "COMPLETED");
  const inProgressTasks = myTasks.filter(
    (task) => task.status === "IN_PROGRESS"
  );
  const pendingTasks = myTasks.filter((task) => task.status === "PENDING");
  const doneTasks = myTasks.filter((task) => task.status === "DONE");

  // Calculate completion rate
  const completionRate =
    myTasks.length > 0
      ? Math.round((completedTasks.length / myTasks.length) * 100)
      : 0;

  // Calculate productivity metrics
  const thisWeek = new Date();
  thisWeek.setDate(thisWeek.getDate() - 7);

  const thisWeekCompleted = completedTasks.filter(
    (task) => task.updatedAt && new Date(task.updatedAt) >= thisWeek
  ).length;

  const lastWeek = new Date();
  lastWeek.setDate(lastWeek.getDate() - 14);
  const lastWeekEnd = new Date();
  lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);

  const lastWeekCompleted = completedTasks.filter(
    (task) =>
      task.updatedAt &&
      new Date(task.updatedAt) >= lastWeek &&
      new Date(task.updatedAt) < lastWeekEnd
  ).length;

  const productivityTrend =
    lastWeekCompleted === 0
      ? thisWeekCompleted > 0
        ? "up"
        : "stable"
      : thisWeekCompleted > lastWeekCompleted
        ? "up"
        : thisWeekCompleted < lastWeekCompleted
          ? "down"
          : "stable";

  // Calculate average completion time (mock data for now)
  const avgCompletionTime = "3.2 days";

  // Priority breakdown
  const highPriorityTasks = myTasks.filter(
    (task) => task.priority === "HIGH"
  ).length;
  const mediumPriorityTasks = myTasks.filter(
    (task) => task.priority === "MEDIUM"
  ).length;
  const lowPriorityTasks = myTasks.filter(
    (task) => task.priority === "LOW"
  ).length;

  // Recent activity (last 7 days)
  const recentActivity = myTasks.filter((task) => {
    const taskDate = new Date(task.updatedAt || task.createdAt);
    return taskDate >= thisWeek;
  }).length;

  return (
    <div className="space-y-6">
      {/* Performance Overview */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card padding="sm">
          <div className="text-center">
            <div className="text-3xl font-bold text-blue-600">
              {completionRate}%
            </div>
            <div
              className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
            >
              Completion Rate
            </div>
          </div>
        </Card>

        <Card padding="sm">
          <div className="text-center">
            <div className="text-3xl font-bold text-green-600">
              {thisWeekCompleted}
            </div>
            <div
              className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
            >
              Tasks This Week
            </div>
            <div className="flex items-center justify-center mt-1">
              {productivityTrend === "up" && (
                <span className="text-green-500 text-xs flex items-center">
                  ‚ÜóÔ∏è +{thisWeekCompleted - lastWeekCompleted} from last week
                </span>
              )}
              {productivityTrend === "down" && (
                <span className="text-red-500 text-xs flex items-center">
                  ‚ÜòÔ∏è {thisWeekCompleted - lastWeekCompleted} from last week
                </span>
              )}
              {productivityTrend === "stable" && (
                <span
                  className={`${isDark ? "text-gray-400" : "text-gray-500"} text-xs`}
                >
                  ‚Üí Same as last week
                </span>
              )}
            </div>
          </div>
        </Card>

        <Card padding="sm">
          <div className="text-center">
            <div className="text-3xl font-bold text-purple-600">
              {avgCompletionTime}
            </div>
            <div
              className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
            >
              Avg Completion
            </div>
          </div>
        </Card>

        <Card padding="sm">
          <div className="text-center">
            <div className="text-3xl font-bold text-orange-600">
              {recentActivity}
            </div>
            <div
              className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
            >
              Recent Activity
            </div>
          </div>
        </Card>
      </div>

      {/* Task Status Breakdown */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card
          title="Task Status Breakdown"
          subtitle="Current task distribution"
        >
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-yellow-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  Pending
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {pendingTasks.length}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-yellow-500"
                    style={{
                      width: `${myTasks.length > 0 ? (pendingTasks.length / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-blue-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  In Progress
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {inProgressTasks.length}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-blue-500"
                    style={{
                      width: `${myTasks.length > 0 ? (inProgressTasks.length / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-orange-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  Done (Review)
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {doneTasks.length}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-orange-500"
                    style={{
                      width: `${myTasks.length > 0 ? (doneTasks.length / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  Completed
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {completedTasks.length}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-green-500"
                    style={{
                      width: `${myTasks.length > 0 ? (completedTasks.length / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </Card>

        <Card title="Priority Distribution" subtitle="Tasks by priority level">
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-red-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  High Priority
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {highPriorityTasks}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-red-500"
                    style={{
                      width: `${myTasks.length > 0 ? (highPriorityTasks / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-yellow-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  Medium Priority
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {mediumPriorityTasks}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-yellow-500"
                    style={{
                      width: `${myTasks.length > 0 ? (mediumPriorityTasks / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span className={isDark ? "text-gray-300" : "text-gray-700"}>
                  Low Priority
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span
                  className={`font-medium ${isDark ? "text-white" : "text-gray-900"}`}
                >
                  {lowPriorityTasks}
                </span>
                <div
                  className={`w-20 h-2 ${isDark ? "bg-gray-700" : "bg-gray-200"} rounded-full overflow-hidden`}
                >
                  <div
                    className="h-full bg-green-500"
                    style={{
                      width: `${myTasks.length > 0 ? (lowPriorityTasks / myTasks.length) * 100 : 0}%`,
                    }}
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </Card>
      </div>

      {/* Performance Insights */}
      <Card title="Performance Insights" subtitle="Your productivity analysis">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4
              className={`font-medium mb-3 ${isDark ? "text-white" : "text-gray-900"}`}
            >
              üìà Productivity Trends
            </h4>
            <div className="space-y-2">
              <div
                className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
              >
                ‚Ä¢ You completed {thisWeekCompleted} tasks this week
              </div>
              <div
                className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
              >
                ‚Ä¢{" "}
                {productivityTrend === "up"
                  ? "Great job! You're improving"
                  : productivityTrend === "down"
                    ? "Focus on completing more tasks"
                    : "Maintaining steady progress"}
              </div>
              <div
                className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
              >
                ‚Ä¢{" "}
                {completionRate >= 80
                  ? "Excellent completion rate!"
                  : completionRate >= 60
                    ? "Good completion rate"
                    : "Consider focusing on completing existing tasks"}
              </div>
            </div>
          </div>

          <div>
            <h4
              className={`font-medium mb-3 ${isDark ? "text-white" : "text-gray-900"}`}
            >
              üéØ Recommendations
            </h4>
            <div className="space-y-2">
              {inProgressTasks.length > 3 && (
                <div
                  className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
                >
                  ‚Ä¢ Focus on completing tasks in progress
                </div>
              )}
              {highPriorityTasks > 0 && (
                <div
                  className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
                >
                  ‚Ä¢ Prioritize your {highPriorityTasks} high-priority tasks
                </div>
              )}
              {doneTasks.length > 0 && (
                <div
                  className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
                >
                  ‚Ä¢ {doneTasks.length} tasks are awaiting manager approval
                </div>
              )}
              {myTasks.length === 0 && (
                <div
                  className={`text-sm ${isDark ? "text-gray-300" : "text-gray-600"}`}
                >
                  ‚Ä¢ No tasks assigned yet. Check with your manager
                </div>
              )}
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
};

export default UserAnalytics;
